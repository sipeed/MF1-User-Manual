# MF 人脸识别模块通信串口协议（Hex版）

## 版本记录

| 文档版本 | 固件版本                              | 编写/修改说明                     | 修改人 | 修订日期 | 备注     |
| -------- | ------------------------------------- | --------------------------------- | ------ | -------- | -------- |
| 1.0.0    | 2020_07_02-std_v101-0-g43ecb42a-dirty | 创建文档                          | TsMax | 20200720 | 首次创建 |
| 1.0.4    | 2020_07_22-std_v104-0-g724e39ec-dirty | 增加 reboot 指令                  | TsMax | 20200722 |          |
| 1.0.5    | 2020_07_23-std_v105-0-ge0a98a98-dirty | 添加soft/hard 设置指令            | TsMax | 20200724 |          |
| 1.0.8    | 2020_07_29-std_v108-0-gb1d9ba4e       | Uartp Json & Bin 添加指令设置图传 | TsMax | 20200728 |          |
| 1.0.9    | 2020_11_02-std_v115-0-g1f620577       | 修复陌生人识别 | TsMax | 20201102 |          |
|          |                                       |                                   |        |          |          |

----

## 1、串口通讯约定

| 参数说明   | 默认值 |
| ---------- | ------ |
| 波特率     | 115200 |
| 数据位     | 8      |
| 奇偶校验位 | 无     |
| 停止位     | 1      |
| 数据流控   | 无     |

## 硬件连接

| MF1 模块 | 说明                                                   |
| -------- | ------------------------------------------------------ |
| `IO5`    | 协议串口的 `TX`,可设置, 默认 `5`,默认波特率为 `115200` |
| `IO4`    | 协议串口的 `RX`,可设置, 默认 `4`                       |

注意：

MF1 TO MF2(即 MF1 外接 2.4/2.8 寸屏幕), USB Type-C 转串口(IO4:TX,RX:IO5)为日志信息输出串口，
IO10(TX), IO11(RX) 为协议串口，用户可以通过指令修改串口 IO


## 2. 帧格式说明

| 帧头          | 长度（byte） | 说明                                                         |
| ------------- | ------------ | ------------------------------------------------------------ |
| 帧头          | 2            | @@/\$\$: **@@**(0x40 0x40)表示启用校验, <br />**$$**(0x24 0x24)表示禁用校验(便于手工调试协议) |
| 帧长度        | 2            | 即完整发送给串口的一帧数据长度，每帧最大 64 KB(是为了 BINCMD_FTRALL 导出全部特征值指令能一次性导出完特征值) |
| 校验位        | 2            | CRC16 格式；**CRC-16/XMODEM**	**x16 + x12 + x5 + 1**      |
| 命令码(cmd)   | 1            | 单字节，最高位表示方向，主机发出 bit7=0, 回复 bit7=1，即回复  `cmd | 0x80` |
| 命令参数(arg) | N            |                                                              |

**注意事项：**

1. 默认波特率为 115200
2. 指令为单个阻塞式，在得到上个指令的回复前发送的指令会被丢弃。每次主循环会处理一次指令，处理周期约 100~150ms。
3. 使用 BINCMD_ABORT 指令可以中断某些长时间执行的指令，比如 BINCMD_RECORD。
4. 对于主机来说，本协议只需要 256/512 字节(127/255人)的串口缓冲区，适用于小容量的单片机。
5. 本协议支持每人最多 8 张人脸模板。
6. 改变波特率的指令的(从机)应答是使用原波特率应答。
7. person_id 为一字节，0xff 占用为特殊用途，所以最多存储 255 人。
   - 使用  person_id + face_idx 可以将人数扩充为 2040人（255x8）
8. CRC16 校验格式为**CRC-16/XMODEM**，校验内容为`命令码+命令参数`
9. 注意模块任何时候返回的指令都会计算校验，主机可选校验：


**备注：**

> cmd: 命令
>
> arg: 参数， arg=NULL 代表不需要参数



## 3.  指令列表

| 命令            | 命令码(值) | 指令回复 |说明                   |
| --------------- | ---------- | --- |---------------------- |
| BINCMD_PING     | 0x00       | 指令 | ping 指令              |
| BINCMD_ABORT    | 0x01       | 指令 |  中断当前执行指令       |
| BINCMD_INFO     | 0x02       | 指令 |  查询板卡信息           |
| BINCMD_BAUD     | 0x03       | 指令 |  设置波特率             |
| BINCMD_RECORD   | 0x04       | 指令 |  开始录入人脸           |
| BINCMD_CONFIRM  | 0x05       | 指令 |  确认录入人脸           |
| BINCMD_DEL      | 0x06       | 指令 |  删除指定 ID 人脸       |
| BINCMD_FR_RUN   | 0x07       | 指令 |  开始/停止运行人脸识别  |
| BINCMD_FR_RES   | 0x08       | 回复 |  模块返回的人脸识别结果 |
|                 |            |  |                         |
| BINCMD_FR_GATE  | 0x09       | 指令 |  设置人脸识别门限       |
| BINCMD_LED      | 0x0a       | 指令 |  设置LED灯状态          |
| BINCMD_RELAY    | 0x0b       | 指令 |  设置继电器状态         |
| BINCMD_RSTCFG   | 0x0c       | 指令 |  复位板级配置到默认     |
| BINCMD_IMPORT   | 0x10       | 指令 |  导入人脸信息           |
| BINCMD_FCNT     | 0x11       | 指令 |  获取人脸库里的数量     |
| BINCMD_FLIST    | 0x12       | 指令 |  返回人脸列表           |
| BINCMD_FTR      | 0x13       | 指令|  返回人脸特征值         |
| BINCMD_FTRALL   | 0x14       | 指令 |  导出所有人脸特征值     |
| BINCMD_QRSCAN   | 0x15       | 指令 |  开启二维码扫码         |
| BINCMD_QRRES    | 0x16       | 指令 |  二维码扫码结果         |
|                 |            |  |                         |
| BINCMD_FACEPOS  | 0x17       | 指令 |  人脸坐标信息           |
| BINCMD_PICADD   | 0x20       | 指令 |  增加在画面显示的图片   |
| BINCMD_STRADD   | 0x21       | 指令 |  增加在画面显示的字符   |
| BINCMD_DISDEL   | 0x22       | 指令 |  清除界面上显示的图片   |
| BINCMD_REBOOT   | 0x23       | 指令 |  重启设备               |
| BINCMD_SOFT_CFG | 0x24       | 指令 |  板子配置               |
| BINCMD_HARD_CFG | 0x25       | 指令 |  板子硬件IO配置         |
| BINCMD_INVALID  | 0xff       | 指令 |  非法指令               |


串口错误码列表

```
typedef enum
{
    BINERR_NONE    = 0,
    BINERR_ERR     = 1,
    BINERR_ARG     = 2,
    BINERR_BAUD    = 3,
    BINERR_STOREDB = 4,
    BINERR_NOFACE  = 5,
    BINERR_FRTYPE  = 6,
    BINERR_NOMEM   = 7,
    BINERR_NOID    = 8,
    BINERR_RECOK   = 9,
    BINERR_RECTO   = 10, // timeout
    BINERR_RECFULL = 11, // flash full
    BINERR_RECID   = 12, // 录入使用的ID错误
    BINCMD_QRTO    = 13, // 扫码超时
    BINCM_POP_FAILE= 14,
}mfbin_err_t;
```

## 4. 指令详述

**注：** 以下示例发送的指令均不使用校验

### 4.1 ping 指令 - 查询模块是否存在(BINCMD_PING 0x00)

说明：

1. 在模块启动完毕后，模块会主动向主机发送该指令表示启动完成。
2. arg=NULL

**主机发送：**

| 格式                  | 帧头(2 Byte) | 帧长度(2 Byte) | 校验码(2 Byte)           | 命令码(1 Byte)    | 命令参数(N Byte) |
| --------------------- | ------------ | -------------- | ------------------------ | ----------------- | ---------------- |
| 指令数据(16 进制发送) | 0x24 0x24    | 0x07 0x00      | 0xFF 0xFF (这里禁用校验) | 0x00(BINCMD_PING) | arg=NULL         |

**模块返回 pong 指令**

| 格式                  | 帧头(2 Byte) | 帧长度(2 Byte) | 校验码(2 Byte) | 命令码(1 Byte)            | 命令参数(N Byte) |
| --------------------- | ------------ | -------------- | -------------- | ------------------------- | ---------------- |
| 指令数据(16 进制发送) | 0x40 0x40    | 0x07 0x00      | 0x88 0x91      | 0x80`(BINCMD_PING \|0X80)` | arg=NULL         |

**指令示例：**

> （从串口助手拷贝出的记录，收表示主机收到模块的信息，发表示主机发往模块的信息）：
>
> （以下示例是手工发送指令测试，所以发送方禁用了校验）

   ```shell
   [11:37:26.400]收←◆40 D8 95 20 5C A9 77 08 8F 29 56 3C A6 C9 9A 26 4B 99 36 20 09 BB C8 49 41 19 BF C0 17 48 83 19 12 08 92 10 88 12 82 10 B8 25 4C B8 25 4C A8 24 44 88 D2 10 90 A0 44 B3 83 00 35 A4 48 B6 51 40 61 01 23 01 9A 01 01 97 01 01 4F 1C 00 01 19 A8 3F 0B 06 C9 9A 26 40 D9 1F 31 89 87 C0 0B 01 0F B3 80 3B A0 98 BA 90 02 91 40 88 89 0B B1 44 C8 59 01 52 5C 80 2B 5D 48 88 B3 16 22 40 3D CD B6 A1 0D 92 F0 49 4E DD 5E 15 01 25 4A 49 09 48 90 15 0F 11 29 8A 12 0B 09 09 0A 02 00 09 0B 09 09 0B 09 09 0B 09 09 0D 9B B2 CD FE 90 61 FB F7
   [11:37:26.640]收←◆8D 7F F4
   /*以上为开机信息，忽略即可，以下为启动完成的信息*/
   [11:37:26.912]收←◆40 40 07 00 00 00 00 //模块上电之后向主机发送 ping 指令,主机可不回复
   [11:37:36.067]发→◇24 24 07 00 FF FF 00 //主机向模块发送ping
   [11:37:36.080]收←◆40 40 07 00 88 91 80 //模块回复 pong, 任何时候模块都会计算校验,主机可选校验
   ```

### 4.2 中断执行指令(BINCMD_ABORT 0x01)

**说明：**

1. 使用 BINCMD_ABORT 指令可以中断某些长时间执行的指令，比如 BINCMD_RECORD4
2. arg=NULL

**主机发送:**

| 格式                  | 帧头(2 Byte) | 帧长度(2 Byte) | 校验码(2 Byte)           | 命令码(1 Byte)    | 命令参数(N Byte) |
| --------------------- | ------------ | -------------- | ------------------------ | ----------------- | ---------------- |
| 指令数据(16 进制发送) | 0x24 0x24    | 0x07 0x00      | 0xFF 0xFF (这里禁用校验) | 0x01(BINCMD_PING) | arg=NULL         |

**模块响应:**

| 格式                  | 帧头(2 Byte) | 长度(2 Byte) | 校验码(2 Byte)           | 命令码(1 Byte)            | 命令参数(N Byte) |
| --------------------- | ------------ | ------------ | ------------------------ | ------------------------- | ---------------- |
| 指令数据(16 进制发送) | 0x40 0x40    | 0x07 0x00    | 0xA9 0x28 | 0x81`(BINCMD_ABORT\|0X80)` | 0x00             |

**指令示例：**

   ```shell
   [15:24:55.869]发→◇24 24 07 00 FF FF 01 //中断执行命令
   [15:24:55.947]收←◆40 40 08 00 A9 28 81 00
   ```

### 4.3 获取板卡信息(BINCMD_INFO 0x02)

**说明：**

1. 获取板卡信息，目前信息待定.
2. arg=NULL

**主机发送：**

| 格式                  | 帧头(2 Byte) | 帧长度(2 Byte) | 校验码(2 Byte)           | 命令码(1 Byte)    | 命令参数(N Byte) |
| --------------------- | ------------ | -------------- | ------------------------ | ----------------- | ---------------- |
| 指令数据(16 进制发送) | 0x24 0x24    | 0x07 0x00      | 0xFF 0xFF (这里禁用校验) | 0x02(BINCMD_INFO) | arg=NULL         |

**模块响应:**

| 格式                  | 帧头(2 Byte) | 长度(2 Byte) | 校验码(2 Byte) | 命令码(1 Byte)            | 命令参数(N Byte) |
| --------------------- | ------------ | ------------ | -------------- | ------------------------- | ---------------- |
| 指令数据(16 进制发送) | 0x40 0x40    | 0x07 0x00    | 0x88 0X91      | 0x82`(BINCMD_INFO \|0X80)` | 0x00             |

**指令示例：**

   ```shell
   [15:37:16.043]发→◇24 24 07 00 FF FF 02 //获取板卡信息
   [15:37:16.121]收←◆40 40 17 00 E8 79 82 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00
   ```

### 4.4 设置波特率(BINCMD_BAUD 0x03)

**说明：**

1. 设置波特率：注意：模块响应的信息是使用原波特率回复

2. arg=baud_rate[4 byte] 小端顺序依次发送

   | arg              | 取值                       | 说明                                                         |
   | ---------------- | -------------------------- | ------------------------------------------------------------ |
   | baud_rate(4byte) | (示例) 0x80 0x25 0x00 0x00 | 9600 即 0x00 0x00 0x25 0x80(MSB), LSB 即为 0x80 0x25 0x00 0x00 |
   |                  | (示例) 0x00 0xC2 0x01 0x00 | 115200 即 0x00 0x01 0xC2 0X00(MSB), LSB 即为 0x00 0xC2 0x01 0x00 |


**主机发送**

| 格式                  | 帧头(2 Byte) | 帧长度(2 Byte) | 校验码(2 Byte)           | 命令码(1 Byte)    | 命令参数(N Byte) |
| --------------------- | ------------ | -------------- | ------------------------ | ----------------- | ---------------- |
| 指令数据(16 进制发送) | 0x24 0x24    | 0x07 0x00      | 0xFF 0xFF (这里禁用校验) | 0x03(BINCMD_INFO) |                  |

**模块响应:**

| 格式                  | 帧头(2 Byte) | 长度(2 Byte) | 校验码(2 Byte) | 命令码(1 Byte)            | 命令参数(N Byte) |
| --------------------- | ------------ | ------------ | -------------- | ------------------------- | ---------------- |
| 指令数据(16 进制发送) | 0x40 0x40    | 0x07 0x00    | 0x4E 0x83      | 0x82`(BINCMD_INFO \|0X80)` | 0x00             |


**示例：**

```shell
[15:56:10.807]发→◇24 24 0B 00 FF FF 03 80 25 00 00 //在波特率 115200 情况下,发送指令将波特率设置 9600
[15:56:10.885]收←◆40 40 08 00 CB 4E 83 00 //用原波特率 115200 响应
[15:56:15.919]发→◇24 24 0B 00 FF FF 03 80 25 00 00 //再次以波特率 115200,发送任意指令 无回复
[15:59:55.926]发→◇24 24 0B 00 FF FF 03 80 25 00 00 //将串口助手波特率切换到 9600, 发送指令
[15:59:55.956]收←◆40 40 08 00 CB 4E 83 00 //收到回复
[16:00:27.150]发→◇24 24 0B 00 FF FF 03 00 C2 01 00 // 在波特率 9600 情况下,将波特率设置为 115200
[16:00:27.364]收←◆40 40 08 00 CB 4E 83 00 // 用原波特率 9600 响应
[16:00:30.470]发→◇24 24 0B 00 FF FF 03 00 C2 01 00 //以波特率 115200 发送指令
[16:00:39.972]收←◆40 40 08 00 CB 4E 83 00 //模块以 9600 响应成功
```

###  4.5 人脸录入(BINCMD_RECORD 0x04):

**说明：**

1. 人脸录入指令
2. arg= **person_id**, **face_idx**, **timeout_s**, **confirm_flag**

| arg | 取值 |  说明 |
| --- | --- | --- |
| person_id:(1 byte) | 0~254 | 人脸 ID |
| face_idx:(1 byte) | 0~7. | 同一人脸的人脸张数，注意不支持写入到已存在的 person_id 与 face_idx,需要先删除，再添加 |
| timeout_s:(1 byte) | 0~255 | 设置人脸识别超时时间，单位秒 |
| confirm_flag(1 byte) | 0/1| 录入后立即生效，还是执行 BINCMD_CONFIRM 后生效|

> 如果使能了 confirm_flag, 则模块在收到 BINCMD_CONFIRM 之前，会把录入的人脸暂存到 ram（最多8份）
> 直到收到 BINCMD_CONFIRM 后将暂存的人脸存入flash

录入成功后屏幕上默认会有简易UI提示，用户可以定制修改。

录入成功时会返回当前用户的坐标信息,顺序为l_eye_x, l_eye_y, r_eye_x, r_eye_y, nose_x, nose_y, l_mouth_x, l_mouth_x, r_mouth_x, r_mouth_y, face_w, face_h,基本与`BINCMD_FACEPOS`相同

**主机发送**

| 格式                  | 帧头(2 Byte) | 帧长度(2 Byte) | 校验码(2 Byte)           | 命令码(1 Byte)      | 命令参数(N Byte) |
| --------------------- | ------------ | -------------- | ------------------------ | ------------------- | ---------------- |
| 指令数据(16 进制发送) | 0x24 0x24    | 0x07 0x00      | 0xFF 0xFF (这里禁用校验) | 0x04(BINCMD_RECORD) | arg              |

**模块响应:**

| 格式                  | 帧头(2 Byte) | 长度(2 Byte) | 校验码(2 Byte) | 命令码(1 Byte)             | 命令参数(N Byte) |
| --------------------- | ------------ | ------------ | -------------- | -------------------------- | ---------------- |
| 指令数据(16 进制发送) | 0x40 0x40    | 0x07 0x00    | 0x5C 0xD7      | 0x84`(BINCMD_RECORD\|0X80)` | 0x00             |

**示例：**

   ```shell
   [16:23:25.593]发→◇24 24 0B 00 FF FF 04 00 00 05 00 //录入人脸，设置超时时间为 5 秒
   [16:23:25.648]收←◆40 40 08 00 5C D7 84 00 // 模块应答收到
   [16:23:31.088]收←◆40 40 08 00 16 76 84 0A //5 秒内未出现人脸，模块提示超时
   [16:23:55.275]发→◇24 24 0B 00 FF FF 04 00 00 05 00 //再次录入人脸
   [16:23:55.327]收←◆40 40 08 00 5C D7 84 00 //应答
   ```

### 4.6 确认录入人脸(BINCMD_CONFIRM 0x05)

**说明:**

1.确认人脸录入指令

2.arg = **confirm**

| arg             | 取值 | 说明                                                       |
| --------------- | ---- | ---------------------------------------------------------- |
| confirm(1 byte) | 0x01 | 0x00, 抛弃之前录入的人脸；0x01,之前录入的人脸正式入库生效; |

**主机发送**

| 格式                  | 帧头(2 Byte) | 帧长度(2 Byte) | 校验码(2 Byte)           | 命令码(1 Byte)       | 命令参数(N Byte) |
| --------------------- | ------------ | -------------- | ------------------------ | -------------------- | ---------------- |
| 指令数据(16 进制发送) | 0x24 0x24    | 0x07 0x00      | 0xFF 0xFF (这里禁用校验) | 0x05(BINCMD_CONFIRM) |                  |

**模块响应:**

//TODO: 响应参数是？

| 格式                  | 帧头(2 Byte) | 长度(2 Byte) | 校验码(2 Byte) | 命令码(1 Byte)              | 命令参数(N Byte) |
| --------------------- | ------------ | ------------ | -------------- | --------------------------- | ---------------- |
| 指令数据(16 进制发送) | 0x40 0x40    | 0x07 0x00    | 0x33 0xFD      | 0x85`(BINCMD_CONFIRM\|0X80)` | 0x00             |

**示例：**

```shel
[22:16:16.349]发→◇24 24 0B 00 FF FF 04 00 00 05 01 □ //录入person00,face0,待确认
[22:16:16.428]收←◆40 40 08 00 EB E4 84 00
[22:16:17.819]收←◆40 40 08 00 2A 79 84 09
[22:16:19.128]发→◇24 24 0B 00 FF FF 04 00 01 05 01 □ //录入person00,face1,待确认
[22:16:19.227]收←◆40 40 08 00 EB E4 84 00
[22:16:20.460]收←◆40 40 08 00 2A 79 84 09
[22:16:21.789]发→◇24 24 0B 00 FF FF 04 00 02 05 01 □ //录入person00,face2,待确认
[22:16:21.867]收←◆40 40 08 00 EB E4 84 00
[22:16:22.636]收←◆40 40 08 00 2A 79 84 09
[22:16:25.424]发→◇24 24 08 00 FF FF 05 01 //<--确认之前的录入
[22:16:25.835]收←◆40 40 08 00 33 FD 85 00
[22:16:40.166]发→◇24 24 07 00 FF FF 11 □    //
[22:16:40.204]收←◆40 40 0A 00 FA C9 91 06 00 01
[22:16:41.063]发→◇24 24 07 00 FF FF 12 □
[22:16:41.131]收←◆40 40 14 00 3C AE 92 00 00 02 00 01 00 00 00 02 00 01 00 00
```

### 4.7 删除储存的人脸（BINCMD_DEL 0x06）

**说明：**

1. 删除存储的人脸指令

2. arg=**person_id**, **face_idx**



| arg                    | 取值            | 说明                                                         |
| ---------------------- | --------------- | ------------------------------------------------------------ |
| **person_id**（1byte） | 0x00~0xff       | 人脸 ID, person_id 设为 0xff，则删除所有人                   |
| **face_id**(1byte)     | 0x00~0x08(0xff) | 同一人脸录入的张数，最多 8 张，设为0xff，则删除该人所录入的人脸 |



**主机发送**

| 格式                  | 帧头(2 Byte) | 帧长度(2 Byte) | 校验码(2 Byte)           | 命令码(1 Byte)   | 命令参数(N Byte) |
| --------------------- | ------------ | -------------- | ------------------------ | ---------------- | ---------------- |
| 指令数据(16 进制发送) | 0x24 0x24    | 0x07 0x00      | 0xFF 0xFF (这里禁用校验) | 0x06(BINCMD_DEL) |                  |

**模块响应:**

| 格式                  | 帧头(2 Byte) | 长度(2 Byte) | 校验码(2 Byte) | 命令码(1 Byte)          | 命令参数(N Byte) |
| --------------------- | ------------ | ------------ | -------------- | ----------------------- | ---------------- |
| 指令数据(16 进制发送) | 0x40 0x40    | 0x07 0x00    | 0x33 0xFD      | 0x86`(BINCMD_DEL\|0X80)` | 0x00             |

**示例：**

   ```shell
   [18:43:06.065]发→◇24 24 07 00 FF FF 11 □        //查询人数
   [18:43:06.171]收←◆40 40 0A 00 E8 EA 91 06 00 03 //3人，6张图片
   [18:43:08.169]发→◇24 24 07 00 FF FF 12 □        //打印所有人信息
   [18:43:08.187]收←◆40 40 14 00 0D 0F 92 00 00 00 00 01 00 02 01 00 01 01 02 00
   [18:43:17.661]发→◇24 24 09 00 FF FF 06 00 02 □  //删除person00的 02号图
   [18:43:17.886]收←◆40 40 08 00 5B D7 86 00       //成功
   [18:43:29.887]发→◇24 24 07 00 FF FF 11 □        //查询人数
   [18:43:29.948]收←◆40 40 0A 00 8C 05 91 05 00 03 //成功减为3人，5张图
   [18:43:31.614]发→◇24 24 07 00 FF FF 12 □        //打印详情
   [18:43:31.659]收←◆40 40 12 00 54 37 92 00 00 00 00 01 01 00 01 01 02 00
   [18:43:33.733]发→◇24 24 09 00 FF FF 06 00 FF □  //删除person00的所有图片
   [18:43:33.899]收←◆40 40 08 00 5B D7 86 00       //成功
   [18:43:35.797]发→◇24 24 07 00 FF FF 11 □        //查询人数
   [18:43:35.851]收←◆40 40 0A 00 DC C2 91 03 00 02 //成功变为2人，3张图
   [18:43:37.797]发→◇24 24 07 00 FF FF 12 □        //打印详情
   [18:43:37.868]收←◆40 40 0E 00 7A 69 92 00 01 00 01 01 02 00
   ```



### 4.8 开始/停止人脸识别 (BINCMD_FR_RUN 0x07)

**说明：**

1. 配置人脸识别:开启/停止人脸识别，识别到人脸输出 id 或 输出人脸特征值

2. arg= **output_type** (0 stop, 1 output only id, 2 output id&ftr)

   | arg         | 取值               | 说明                                              |
   | ----------- | ------------------ | ------------------------------------------------- |
   | output_type | 0(stop)            | 停止人脸识别                                      |
   |             | 1(output only id)  | 识别到人脸后只输出人脸 id                         |
   |             | 2(output id & ftr) | 识别到人脸后输出人脸 id 及 当前画面中人脸的特征值 |

   **主机发送**

   | 格式                  | 帧头(2 Byte) | 帧长度(2 Byte) | 校验码(2 Byte)           | 命令码(1 Byte)      | 命令参数(N Byte) |
   | --------------------- | ------------ | -------------- | ------------------------ | ------------------- | ---------------- |
   | 指令数据(16 进制发送) | 0x24 0x24    | 0x07 0x00      | 0xFF 0xFF (这里禁用校验) | 0x07(BINCMD_FR_RUN) |                  |

   **模块响应:**

   | 格式                  | 帧头(2 Byte) | 长度(2 Byte) | 校验码(2 Byte) | 命令码(1 Byte)             | 命令参数(N Byte) |
   | --------------------- | ------------ | ------------ | -------------- | -------------------------- | ---------------- |
   | 指令数据(16 进制发送) | 0x40 0x40    | 0x07 0x00    | 0x83 0xCE      | 0x87`(BINCMD_FR_RUN\|0X80)` | 0x00             |

   **示例：**

   ```
   [22:52:36.525]发→◇24 24 08 00 FF FF 07 01 □  //开启人脸识别，设置仅上报id，可以观察到红外灯亮起
   [22:52:36.639]收←◆40 40 08 00 83 CE 87 00
   [22:52:38.958]收←◆40 40 0B 00 22 F0 08 01 01 00 02  //识别到录入的人脸，上报，总共一个脸，当前第一个，person00,face02
   [22:52:39.166]收←◆40 40 0B 00 22 F0 08 01 01 00 02  //第二帧上报，时差约0.2s，其中有0.1s是停顿在UI显示，可调整
   [22:52:39.422]收←◆40 40 0B 00 22 F0 08 01 01 00 02  //第三帧
   [22:52:41.598]收←◆40 40 0B 00 22 F0 08 01 01 00 02
   [23:06:44.488]收←◆40 40 0B 00 88 23 08 01 01 FF FF  //FF FF 表示陌生人
   [23:06:44.648]收←◆40 40 0B 00 88 23 08 01 01 FF FF
   [22:52:49.471]发→◇24 24 08 00 FF FF 07 02 □         //设置上报id及特征值
   [22:52:49.534]收←◆40 40 08 00 83 CE 87 00           //下面回复了当前图像中脸的特征值(196B,也可设置为192/128精简版)
   [22:52:50.782]收←◆40 40 CF 00 BE F5 08 01 01 00 00 20 03 0D 1D 24 B9 DD 00 D2 D4 DA E7 E2 51 09 2C E9 15 24 07 E3 32 DF D4 FA 1F EF 0C 3B 45 C6 DD E8 D0 05 EB 13 FB D2 F0 25 F9 FD EF D2 B7 EB 46 22 FF E7 2C E6 C0 04 26 1B 1A 47 CF BC 01 57 00 FA 13 13 19 1D 24 15 38 14 1A 01 13 1C EF 00 F3 F9 FB C4 FF DA F3 26 BE F9 05 F8 F1 D3 E1 BE D8 1F AF 3A BA F9 1B 06 0B FD 23 0B 2E 07 01 0F DD 4D 44 57 F3 FD 1B F8 FB 0C 15 DD BD EB 21 3C 00 09 B7 E4 D5 14 E3 18 21 00 E3 FF ED B9 DC 00 00 3C C8 02 39 0B E5 13 FF 0F 14 FF 17 EF FB CF 15 F3 34 FA 19 ED E2 32 FA E3 3C C6 C6 DA D2 DC 14 ED 27 DC 06 19 27 09 F6 1B F8 FB DA 24 02 FD AF E4 F5 05 0F
   [22:52:57.997]发→◇24 24 08 00 FF FF 07 00 □  //停止人脸识别，可以观察到红外灯关闭
   [22:52:58.127]收←◆40 40 08 00 83 CE 87 00
   ```

### 4.9 模块上报人脸识别结果 (BINCMD_FR_RES 0x08)

**说明: **

1. 模块上报人脸**识别结果**，每次返回一张脸，多人多次返回

2. arg=**i**, **n**, **person_id**, **face_idx**, **[ftr]**

   | arg               | 取值 | 说明                               |
   | ----------------- | ---- | ---------------------------------- |
   | i (1 byte)        | *    | 当前画面中的第 i 张脸(i 从 1 开始) |
   | n(1 byte)         | *    | 当前画面总共有多少张脸             |
   | person_id(1 byte) | *    | 人员ID，0xff表示陌生人             |
   | face_idx(1 byte)  | *    | 同一人员的人脸ID                   |
   | ftr(196 byte)     | *    | 可选输出特征值                     |

**模块输出结果示例(同上一节):**

| 格式                  | 帧头(2 Byte) | 长度(2 Byte) | 校验码(2 Byte) | 命令码(1 Byte)      | 第 i 张脸 | 当前画面总共有多少张脸 | 人员ID | 同一人员的人脸ID | 人脸特征值（196byte， 此处省略） |
| --------------------- | ------------ | ------------ | -------------- | ------------------- | --------- | ---------------------- | ------ | ---------------- | -------------------------------- |
| 指令数据(16 进制发送) | 0x40 0x40    | 0xCF 0x00    | 0xBE 0xF5      | 0x08`BINCMD_FR_RES` | 01        | 01                     | 00     | 00               | **\***                           |



### 4.10 设置人脸识别参数 (BINCMD_FR_GATE 0x09)

**说明：**

1. 设置人脸识别的参数，比对阈值(0 ~ 100,建议80 ~ 90)，活体阈值(0 ~ 100，建议60 ~ 80)，是否需要正视(0/1), [可选]红外识别阈值

2. arg=**compare_gate**,**live_gate**,**front_gate**,**[fe_gate_ir]**

| arg                  | 取值    | 说明                            |
| -------------------- | ------- | ------------------------------- |
| compare_gate(1byte)  | 0 ~ 100 | 人脸比对阈值(0 ~ 100,建议80~90) |
| live_gate(1byte)     | 0 ~ 100 | 活体阈值                        |
| front_gate(1byte)    | 0、1    | 是否需要正视, 0 不需要，1 需要  |
| [fe_gate_ir] (1byte) | 0 ~ 100 | 红外识别阈值[可选]              |

   **主机发送**

| 格式                  | 帧头(2 Byte) | 帧长度(2 Byte) | 校验码(2 Byte)           | 命令码(1 Byte)       | 命令参数(N Byte) |
| --------------------- | ------------ | -------------- | ------------------------ | -------------------- | ---------------- |
| 指令数据(16 进制发送) | 0x24 0x24    | 0x07 0x00      | 0xFF 0xFF (这里禁用校验) | 0x09(BINCMD_FR_GATE) |                  |

   **模块响应:**

| 格式                  | 帧头(2 Byte) | 长度(2 Byte) | 校验码(2 Byte) | 命令码(1 Byte)             | 命令参数(N Byte) |
| --------------------- | ------------ | ------------ | -------------- | -------------------------- | ---------------- |
| 指令数据(16 进制发送) | 0x40 0x40    | 0x07 0x00    | 0x83 0xCE      | 0x87`(BINCMD_FR_RUN\|0X80)` | 0x00             |

**示例**

   ```
   [23:17:37.924]发→◇24 24 0A 00 FF FF 09 5A 50 00 □
   [23:17:37.983]收←◆40 40 08 00 93 54 89 00
   ```

### 4.11 配置 LED 状态 (BINCMD_LED 0x0a)

**说明**

1. LED操作，注意在开启FR_RUN时，会受内部逻辑控制

2. arg=**wled_duty** 有效值为 0~255

   | arg              | 取值    | 说明           |
   | ---------------- | ------- | -------------- |
   | wled_duty(1byte) | 0 ~ 255 | LED 补光灯亮度 |


**主机发送**

| 格式                  | 帧头(2 Byte) | 帧长度(2 Byte) | 校验码(2 Byte)           | 命令码(1 Byte)       | 命令参数(N Byte) |
| --------------------- | ------------ | -------------- | ------------------------ | -------------------- | ---------------- |
| 指令数据(16 进制发送) | 0x24 0x24    | 0x07 0x00      | 0xFF 0xFF (这里禁用校验) | 0x0a(BINCMD_LED) |                  |

**模块响应:**

| 格式                  | 帧头(2 Byte) | 长度(2 Byte) | 校验码(2 Byte) | 命令码(1 Byte)             | 命令参数(N Byte) |
| --------------------- | ------------ | ------------ | -------------- | -------------------------- | ---------------- |
| 指令数据(16 进制发送) | 0x40 0x40    | 0x07 0x00    | 0x83 0xCE      | 0x8a`(BINCMD_LED\|0X80)` | 0x00             |

**示例**

   ```
   [23:27:57.141]发→◇24 24 08 00 FF FF 0A 80 □ //设置白光亮度为一半亮度
   [23:27:57.270]收←◆40 40 08 00 FB 7E 8A 00   //回应ok
   ```

### 4.12 配置继电器状态( BINCMD_RELAY 0x0b)

**说明：**

1. 设置继电器开启一段时间

2. arg=**polarity**, **time**

   | arg         | 取值    | 说明           |
   | ----------- | ------- | -------------- |
   | polarity    | *      | 配置继电器 IO 极性 |
   | time(1byte) | 0 ~ 255 | 配置继电器 IO 脉冲时间，单位为 0.1S |

**示例:**

   ```
   [23:33:18.343]发→◇24 24 08 00 FF FF 0B 0A □        //继电器开启1s
   [23:33:18.415]收←◆45 38 33 40 40 08 00 23 67 8B 00 //回应ok
   ```

### 4.13 重置模块配置 (BINCMD_RSTCFG 0x0c)

**说明：**

1. 复位板卡配置到默认状态, 发送后需要重启板卡生效
2. arg=NULL

**示例:**

```
[18:17:56.489]发→◇24 24 07 00 FF FF 0C □
[18:17:56.565]收←◆40 40 08 00 F5 5E 8C 00
```

### 4.14 导入人脸特征值 (BINCMD_IMPORT 0x10)

**说明：**

1. 导入人脸特征值

2. arg=person_id, face_idx, face_ftr(196B default)

   | arg               | 取值 | 说明                   |
   | ----------------- | ---- | ---------------------- |
   | person_id(1 byte) | *    | 人员ID，0xff表示陌生人 |
   | face_idx(1 byte)  | *    | 同一人员的人脸ID       |
   | ftr(196 byte)     | *    | 可选输出特征值         |

   **示例**

   ```
   [01:39:02.487]发→◇24 24 CD 00 FF FF 10 00 00 19 F1 26 3E 2A BA FD 0F CB DE D0 F7 15 4B 14 0F 00 FB 32 18 CC 2B 00 D0 CB 0C F6 1F 37 41 E1 F1 01 B4 07 DB 20 01 D5 D9 28 D3 0F 0C FC D0 E3 56 02 05 E5 31 D8 AF EA 14 2D 0E 23 C4 A9 0E 44 11 D8 0D 28 0D 18 1F 17 1B 1E 19 03 0A 25 EA 00 05 06 10 CF 03 E0 F1 23 A9 02 1C 09 07 DF D6 D5 D1 1C DB 25 C9 E7 1C EA 17 F8 F9 FD 3A 18 05 0F F4 57 57 5A F5 F1 2D F8 11 2B 02 E0 D1 00 1C 35 00 00 C7 E9 EC 0E E4 1B 16 EE C2 12 07 C6 EF F8 07 45 CA EF 25 07 F4 20 E2 0A 04 2A 1F E7 FF D8 1C EC 19 F9 0B FE 0A 38 25 05 2A BC B0 E3 BD CB 11 17 12 D9 FC 19 17 F8 F7 18 02 11 FA 16 11 00 B2 E9 EE EE 0C □  //导入一张图片
   [01:39:02.613]收←◆40 40 08 00 1A 16 90 00    //返回成功
   [01:39:11.741]发→◇24 24 08 00 FF FF 07 01 □  //测试识别
   [01:39:11.781]收←◆40 40 08 00 83 CE 87 00
   [01:39:13.446]收←◆40 40 0B 00 30 D3 08 01 01 00 00   //成功使用导入的特征值识别
   [01:39:13.654]收←◆40 40 0B 00 30 D3 08 01 01 00 00
   ```

### 4.15 查询人脸库数量 (BINCMD_FCNT 0x11)

**说明：**

1. 查询人脸库数量指令

2. 模块返回参数：

   arg=all_cnt(2B), person_cnt(1B)

   | arg                | 说明                 |
   | ------------------ | -------------------- |
   | all_cnt(2 byte)    | 总记录的人脸图片张数 |
   | person_cnt(1 byte) | 总记录的人脸数       |

   **示例**

   ```
   [18:43:06.065]发→◇24 24 07 00 FF FF 11 □        //查询人数
   [18:43:06.171]收←◆40 40 0A 00 E8 EA 91 06 00 03 //3人，6张图片
   ```

### 4.16 打印人脸库所有人脸数的记录 (BINCMD_FLIST 0x12)

**说明：**

1. 打印人脸库所有的 person_id 和 face_idx

2. 模块返回格式：arg = errcode+[person_id,face_idx]*N

   | arg                           | 说明                                |
   | ----------------------------- | ----------------------------------- |
   | errcode(1 byte)                       | 错误码                              |
   | person_id,face_idxt(2*N byte) | 总记录的人脸图片张数,总记录的人脸数 |

   **示例**

   ```
   [18:43:08.169]发→◇24 24 07 00 FF FF 12 □        //打印所有人信息
   [18:43:08.187]收←◆40 40 14 00 0D 0F 92 00 00 00 00 01 00 02 01 00 01 01 02 00
   ```

### 4.17 查询对应人脸的特征值 (BINCMD_FTR 0x13)

**说明：**

1. 查询对应人脸的特征值

2. 指令参数 arg  = **person_id**, **face_idx**

   | arg           | 说明    |
   | ------------- | ------- |
   | **person_id** | 人员 ID |
   | **face_idx**  | 人脸 ID |

3. 响应参数 out arg = **err_code**,  **person_id**, **face_idx**, **face_ftr**

   | arg           | 说明       |
   | ------------- | ---------- |
   | **err_code**  | 错误码     |
   | **person_id** | 人员 ID    |
   | **face_idx**  | 人脸 ID    |
   | **face_ftr**  | 人脸特征值 |



**示例**

   ```
   [23:36:30.901]发→◇24 24 09 00 FF FF 13 00 00 □ //以下返回：err=0, person00,face00, faceftr(196B)
   [23:36:30.919]收←◆40 40 CE 00 67 6E 92 00 00 00 19 F1 26 3E 2A BA FD 0F CB DE D0 F7 15 4B 14 0F 00 FB 32 18 CC 2B 00 D0 CB 0C F6 1F 37 41 E1 F1 01 B4 07 DB 20 01 D5 D9 28 D3 0F 0C FC D0 E3 56 02 05 E5 31 D8 AF EA 14 2D 0E 23 C4 A9 0E 44 11 D8 0D 28 0D 18 1F 17 1B 1E 19 03 0A 25 EA 00 05 06 10 CF 03 E0 F1 23 A9 02 1C 09 07 DF D6 D5 D1 1C DB 25 C9 E7 1C EA 17 F8 F9 FD 3A 18 05 0F F4 57 57 5A F5 F1 2D F8 11 2B 02 E0 D1 00 1C 35 00 00 C7 E9 EC 0E E4 1B 16 EE C2 12 07 C6 EF F8 07 45 CA EF 25 07 F4 20 E2 0A 04 2A 1F E7 FF D8 1C EC 19 F9 0B FE 0A 38 25 05 2A BC B0 E3 BD CB 11 17 12 D9 FC 19 17 F8 F7 18 02 11 FA 16 11 00 B2 E9 EE EE 0C
   ```

### 4.18 导出所有人脸信息 (BINCMD_FTRALL 0x14)

1. 导出所有人脸信息，一般用于上位机的导出所有信息，然后导到其他机器。
2. 响应参数 arg= errcode,[person_id,face_idx,face_ftr]*N

**示例**

   ```
   [23:40:42.566]发→◇24 24 07 00 FF FF 14 □
   [23:40:42.646]收←◆40 40 AC 04 9E AD 92 00   //以下返回了存储的6个脸，分属于3个人
   00 00 19 F1 26 3E 2A BA FD 0F CB DE D0 F7 15 4B 14 0F 00 FB 32 18 CC 2B 00 D0 CB 0C F6 1F 37 41 E1 F1 01 B4 07 DB 20 01 D5 D9 28 D3 0F 0C FC D0 E3 56 02 05 E5 31 D8 AF EA 14 2D 0E 23 C4 A9 0E 44 11 D8 0D 28 0D 18 1F 17 1B 1E 19 03 0A 25 EA 00 05 06 10 CF 03 E0 F1 23 A9 02 1C 09 07 DF D6 D5 D1 1C DB 25 C9 E7 1C EA 17 F8 F9 FD 3A 18 05 0F F4 57 57 5A F5 F1 2D F8 11 2B 02 E0 D1 00 1C 35 00 00 C7 E9 EC 0E E4 1B 16 EE C2 12 07 C6 EF F8 07 45 CA EF 25 07 F4 20 E2 0A 04 2A 1F E7 FF D8 1C EC 19 F9 0B FE 0A 38 25 05 2A BC B0 E3 BD CB 11 17 12 D9 FC 19 17 F8 F7 18 02 11 FA 16 11 00 B2 E9 EE EE 0C
   00 01 1B E9 26 39 20 B4 EF 0A DA E0 C7 EB 00 45 15 12 00 FB 33 15 DE 26 00 DC D5 12 F7 13 3F 3E C6 DE F5 C1 11 F3 28 01 D0 E5 27 CA 1B 13 01 C7 F6 51 00 FB E8 1C D6 B4 E3 17 2A 25 2C C8 B4 00 43 0D E9 0F 30 14 23 30 15 27 23 28 07 14 26 EF 02 0A 20 18 D9 09 E6 ED 23 A7 10 08 08 05 D8 D8 C6 C8 21 D8 1B CE 00 1A F3 11 F1 04 ED 3C 0F 00 FC E3 54 46 5E FA DE 1C ED 10 33 0D D9 D8 FE 23 46 01 FC B7 E9 F8 06 F3 23 10 F8 C4 12 F6 CD F8 FD 01 3C C7 F1 2B 0D ED 15 F6 02 09 2B 26 F2 18 E0 16 E2 1E E9 FC FB F7 34 15 EF 2B B9 C5 EF B0 CF 0B 0D 21 D9 FF 23 20 F5 FA 18 0B FB E2 17 1D FA B2 EB 04 F7 18
   00 02 1F F8 1D 2B 33 B6 ED 06 D2 E8 C9 F2 12 54 0E 28 F0 0C 30 20 E5 2E FB DB D8 05 F2 10 3F 3B E0 F5 F8 B0 0C E0 0E FE D8 E5 24 DB 12 09 E2 C0 E9 46 F9 0A E8 2D E6 B6 E9 16 2C 0C 33 C3 A9 0C 4D 13 DB 11 2E 1E 0D 1A 0E 31 11 2D 04 FD 1C E8 FE 04 06 0B D0 FA E8 EF 20 AA 0C 18 02 07 E2 E2 CF C9 23 D7 20 C6 ED 0E F7 14 FD 00 03 32 09 01 0E F2 46 56 5D F1 EF 30 02 10 2E 0E CF D6 FB 29 47 04 02 C7 E3 E2 09 E3 28 1E EB CD FC 03 D4 E7 F9 11 51 BF 00 25 06 ED 11 E0 09 03 20 28 E5 08 DA 1F EA 1A F0 03 FD 08 29 16 F1 3B BE B7 F9 AA DB 22 0A 22 E4 00 09 25 03 ED 1A 04 09 F8 0F 13 09 B5 D0 01 F4 09
   01 00 12 EB 1E 3B 2C B6 FE 0A D2 E3 CC F3 02 4D 1B 0B 01 F3 37 1A D9 20 05 DE CF 16 FB 25 44 3C DC E6 FB C4 0D F0 27 02 D4 E7 28 D0 0E 16 0B CE E9 5C FB 0D E8 28 D5 C0 E3 0A 1F 10 2B CD AB 0D 42 16 D9 0A 2B 0E 25 38 0A 15 1D 1A 08 15 23 F3 F9 03 0B 15 D5 06 E2 E6 20 A7 0D 0D 0C FF DD D3 D1 C8 22 E4 28 C8 E6 17 E8 20 F2 08 FB 39 1F FE 08 E3 53 48 56 E9 E8 20 F2 12 30 0F DF CA FE 26 45 05 02 B8 E7 E3 04 F2 2C 1C F4 CD 09 FF C2 00 07 FB 38 CA EB 28 06 F0 26 E2 08 02 24 20 EA 0E D6 2E E3 1A EF 0E 04 00 38 18 FA 21 BD B4 E4 BA D0 09 0D 14 DD FE 20 28 F4 FC 1D 0B 09 F3 20 0D FE AF EC 09 EE 0A
   01 01 2E F7 26 3F 26 B1 FE FC E1 D8 D1 EC 07 44 17 07 FC 0C 41 18 C7 27 03 EA C3 07 EF 12 46 2E D7 E8 00 BC 03 F6 20 0C CC E3 24 DA 0D 06 09 D1 F6 5C EE 07 EB 3E C6 A9 E6 14 3A 22 2F C4 AB 1D 41 26 DE 1A 22 14 1B 29 07 15 18 15 07 17 20 E5 F9 07 0F 07 D9 F8 F1 EE 20 B0 0C 0C 0B 02 DD E4 D0 CC 26 D5 1D C5 E9 10 E3 1D 00 0A E8 35 0D FE 09 ED 4D 45 4F FD F2 29 F2 0F 32 10 E2 CE F4 1F 3A 0C 07 D2 D8 F6 0A DC 2C 1B E4 C6 14 FB CD FC F9 04 3A D7 F7 13 05 EF 1B E1 FE 0E 45 24 DE 0F CD 19 E4 1D F1 09 F3 FD 31 24 FD 32 C4 B6 EB B3 CD 1F 1A 1A D5 FF 04 15 F9 F8 1A FC 09 F3 15 18 F5 BE E3 FC F6 11
   02 00 0D EC 27 24 34 C3 E3 02 EE E1 CE 02 F6 2F 14 28 08 00 19 23 DB 18 0B CF E1 04 E6 1A 3F 42 DB F3 FE C8 0E EC 25 EE EC ED 1D CC 19 08 F2 C6 D8 4F FF 0C F5 29 D7 A9 E3 1F 20 28 2E DE A5 EE 52 0E D2 25 1F 22 15 22 10 17 28 37 11 0B 19 EC F7 0F 22 19 CF FE E9 E0 27 A5 05 02 14 FA EB D1 D0 E6 0F C9 13 BC 15 14 EC 0B FE 05 F7 4E 18 14 02 EC 4B 38 62 ED F1 1D F2 0B 3D 00 D7 DA 00 29 34 F6 02 AD EF E3 0F EB 23 0F 09 C5 F8 FB BE DB 16 15 31 D1 F4 2A 09 E9 26 F4 0C 02 2E 22 0D 14 E6 0B E2 17 E2 FD FE F8 27 14 F5 3A B6 B8 02 A6 E6 06 0E 45 E5 0A 14 1E 11 E5 23 00 14 F3 1A 14 FE BD DE 09 F9 0B
   ```

### 4.19 开启扫描二维码 (BINCMD_QRSCAN 0x15)

**说明：**

1. 开启扫描二维码

2. arg=**timeout_s**

**示例**

   ```
   24 24 08 00 FF FF 15 0A
   ```

### 4.20 二维码返回结果 (BINCMD_QRRES 0x16)

**说明：**

1. 二维码返回结果, qrcode以00结尾

2. arg=err_code+[qrcode]

**示例**



### 4.21 模块上报人脸坐标信息 (BINCMD_FACEPOS 0x17)

**说明：**

1. 模块上报人脸坐标信息，每次一人，多人多次返回

2. arg=i,n,l_eye_x, l_eye_y, r_eye_x, r_eye_y, nose_x, nose_y, l_mouth_x, l_mouth_y, r_mouth_x, r_mouth_y, face_w, face_h， person_id, face_idx

   >  人脸五点坐标是以人脸框左上角为坐标原点



   | arg        | 取值 | 说明                               |
   | ---------- | ---- | ---------------------------------- |
   | i (1 byte) | *    | i, 当前画面中的第i张脸（i从1开始） |
   | n          | *    | n，当前画面总共有多少张脸          |
   | l_eye_x    | *    | 人脸左眼 X 坐标                    |
   | l_eye_y    | *    | 人脸左眼 Y 坐标                    |
   | r_eye_x    | *    | 人脸右眼 Y 坐标                    |
   | r_eye_y    | *    | 人脸右眼 Y 坐标                    |
   | nose_x     | *    | 人脸鼻子 X 坐标                    |
   | nose_y     | *    | 人脸鼻子 Y 坐标                    |
   | l_mouth_x  | *    | 人脸嘴巴左端 X 坐标                |
   | l_mouth_y  | *    | 人脸嘴巴左端 Y 坐标                |
   | r_mouth_x  | *    | 人脸嘴巴右端 X 坐标                |
   | r_mouth_y  | *    | 人脸嘴巴右端 Y 坐标                |
   | face_w     | *    | 人脸框 宽度                        |
   | face_h     | *    | 人脸框 高度                        |
   | person_id  | *    | 人员 ID，0xff 表示陌生人           |
   | face_idx   | *    | 人脸 ID                            |



**示例**



### 4.22 在屏幕上显示图片 (BINCMD_PICADD 0x20)

**说明：**

1. 在屏幕上显示图片，需要预先在flash中写入图片资源。用户指定 ID，后面使用对应 ID 来删除

2. arg=id(1B), alpha(1B), resize(1B), flash_offset_addr(4B), w(2B), h(2B), x(2B), y(2B)
   所有参数为小端存储。

   | arg                       | 取值  | 说明                                                         |
   | ------------------------- | ----- | ------------------------------------------------------------ |
   | id(1 byte)                | 0~255 | id 为用户设置的图片资源 id 号，0~254。注意如果id重复，会被新设置的图片取代。 |
   | alpha(1 byte)             | 0~255 | alpha=0 不透明; =255 全透明                                  |
   | resize(1 byte)            | 0/1   | resize=0 不进行缩放, resize=1 图片2x2缩放                    |
   | flash_offset_addr(4 byte) | *     | 指定图片资源在 flash 中的偏移地址                            |
   | width(2 byte)             | *     | 指定图片宽度                                                 |
   | height(2 byte)            | *     | 指定图片高度                                                 |
   | x(2 byte)                 | *     | 图片显示的起始 x 坐标                                        |
   | y(2 byte)                 | *     | 图片显示的起始 y 坐标                                        |

> **注意:MF1**，横屏的 x 需要加 40 偏移，竖屏的 y 需要加 40 偏移



**示例**


   ```
   [23:49:56.446]发→◇24 24 15 00 FF FF 20 00 80 00 0C C7 00 F0 00 F0 00 00 00 24 00 □
   [23:49:56.518]收←◆40 40 08 00 B8 A0 A0 00  //可见屏幕上半透明叠加了一张图片
   [00:45:25.453]发→◇24 24 15 00 FF FF 20 01 80 00 00 C0 00 10 00 10 00 00 00 29 00 □
   [00:45:25.509]收←◆40 40 08 00 B8 A0 A0 00  //不透明地叠加图片
   ```


### 4.23 在屏幕上显示字符串 (BINCMD_STRADD 0x21)

**说明：**

1. 在屏幕上显示字符串
2. arg=id(1B),x(2B),y(2B),size(16/32),color(RGB565),bg_color(RGB565),zhCN(1B),String(nB)


| arg              | 取值  | 说明                                                         |
| ---------------- | ----- | ------------------------------------------------------------ |
| id(1 byte)       | 0~255 | id：表示资源 id，与图片共用 0~254 的 id 号空间               |
| x(2 byte)        | *     | 图片显示的起始 x 坐标                                        |
| y(2 byte)        | *     | 图片显示的起始 y 坐标                                        |
| size(1 byte)     | 16/32 | 配置字体大小，字体大小可选 16/32                             |
| color(2 byte)    | *     | 配置字体颜色 color(RGB565)                                   |
| bg_color(2 byte) | *     | 配置字体背景颜色 bg_color(RGB565)                            |
| zhCN(1B)         | 0/1   | zhCN 为 1 表示字符串中包含中文字符，如果包含中文字符，需要GB2312编码。 |
| String(nB)       | *     | String 本身的长度信息包含在帧头的长度中，但也需要以 00 结尾<br />中文示例：<br />>  矽     速     科     技        @      你     好     世     界<br />>  CE F9 CB D9 BF C6 BC BC 20 40 20 C4 E3 BA C3 CA C0 BD E7 |

**示例**


   ```
[01:24:37.853]发→◇24 24 18 00 FF FF 21 02 00 00 40 00 10 FF FF 00 00 00 31 32 33 34 35 00 □ //黑底白字显示'12345'
[01:24:37.974]收←◆40 40 08 00 60 B9 A1 00
[01:24:46.389]发→◇24 24 26 00 FF FF 21 03 00 00 80 00 10 00 F8 FF FF 01 CE F9 CB D9 BF C6 BC BC 20 40 20 C4 E3 BA C3 CA C0 BD E7 00 □  //白底红字显示'矽速科技 @ 你好世界'
[01:24:46.501]收←◆40 40 08 00 60 B9 A1 00
   ```





### 4.24 删除指定id图片 (BINCMD_DISDEL 0x22)

**说明：**

1. 删除指定id图片

2. arg=id

   | arg        | 取值  | 说明                                        |
   | ---------- | ----- | ------------------------------------------- |
   | id(1 byte) | 0~255 | 删除指定 ID 的图片，0xff 表示删除所有图片。 |

**示例**

   ```
   [00:46:55.708]发→◇24 24 08 00 FF FF 22 FF □  //接上节内容执行，可见屏幕上所有内容被清空
   [00:46:55.766]收←◆40 40 08 00 08 93 A2 00
   ```

### 4.25 重启设备 (BINCMD_REBOOT 0x23)

**说明：**

1. 重启设备

2. arg=key; 固定为0xD9

   | arg         | 取值 | 说明                    |
   | ----------- | ---- | ----------------------- |
   | key(1 byte) | 0xD9 | 重启指令参数固定为 0xD9 |

**示例**

   ```
   发-> 24 24 08 00 FF FF 23 D9
   收-> 40 40 08 00 2D 48 A3 00
   ```

### 4.26 读取/设置软件配置 (BINCMD_SOFT_CFG 0x24)

**说明：**

1. 读取/设置软件配置

2. arg=get_cfg,cam_flip,cam_mirror,lcd_flip,lcd_mirro,uartp_out_fea,uartp_auto_out_fea,uartp_en_stranger,uartp_stranger_fea,uartp_out_interval_ms


   当 get_cfg = 0x01 时表示读取当前配置,模块回复的顺序与设置的参数一致,get_cfg为0xD9

   当 get_cfg != 0x01 时表示进行设置,模块回复设置结果,0x00表示成功,其他值为失败

   | arg                           | 取值 | 说明                                                         |
   | ----------------------------- | ---- | ------------------------------------------------------------ |
   | get_cfg(1 byte)               | *    | 当 get_cfg = 0x01 时表示读取当前配置,模块回复的顺序与设置的参数一致,get_cfg为0xD9<br />当 get_cfg != 0x01 时表示进行设置,模块回复设置结果,0x00表示成功,其他值为失败 |
   | cam_flip(1 byte)              | *    | 0x01: 启用摄像头水平翻转                                           |
   | cam_mirror(1 byte)            | *    | 0x01: 启用摄像头垂直镜像                                           |
   | lcd_flip(1 byte)              | *    | 0x01: 启用 lcd 水平翻转                                            |
   | lcd_mirro(1 byte)             | *    | 0x01: 启用 lcd 垂直镜像                                            |
   | uartp_out_fea(1 byte)         | 0x01, 0x02, 其他取值    | 0x01：输出存储在 flash 中的人脸特征值，分数,人脸 ID；</br> 0x02：输出实时的人脸特征值，人脸 ID；其他取值：只输出人脸 ID                        |
   | uartp_auto_out_fea(1 byte)    | *    | 0x01：自动输出人脸特征值                                         |
   | uartp_en_stranger(1 byte)     | *    | 0x01: 使能输出陌生人人脸信息                                    |
   | uartp_stranger_fea(1 byte) | * | 0x01：输出陌生人人脸特征值 |
   | uartp_out_interval_ms(1 byte) | *    | 配置输出人脸信息间隔                                         |

**示例**

   ```
   发-> 24 24 11 00 FF FF 24 00 01 00 00 00 01 00 00 00 64
   收-> 40 40 11 00 20 92 A4 D9 01 00 00 00 00 00 00 00 64
   ```

### 4.27 读取/设置硬件配置 (BINCMD_HARD_CFG 0x25)

**说明：**

1. 读取/设置硬件配置

2. arg=get_cfg,port_tx,port_rx,log_tx,log_rx,relay_pin,relay_pol,relay_opent,key_pin,key_pol

   | arg | 取值 | 说明 |
   | ------ | ---- | ---- |
   | get_cfg(1 byte)         | *    | 当 get_cfg = 0x01 时表示读取当前配置,模块回复的顺序与设置的参数一致,get_cfg为0xD9<br />当 get_cfg != 0x01 时表示进行设置,模块回复设置结果,0x00表示成功,其他值为失败 |
   | port_tx(1 byte) | *    | 配置协议串口 TX IO |
   | port_rx(1 byte) | *    | 配置协议串口 RX IO |
   | log_tx(1 byte) | *    | 配置日志串口 TX IO |
   | log_rx(1 byte)          | *    | 配置日志串口 RX IO |
   | relay_pin(1 byte)       | *    | 配置继电器输出 IO |
   | relay_pol(1 byte)       | *    | 配置继电器极性 |
   | relay_open_time(1 byte) | *    | 配置继电器开启时长, 单位 0.1S |
   | key_pin(1 byte)         | *    | 配置功能按键 IO |
   | key_pol(1 byte)         | *    | 配置功能按键触发电平 |
   | baud(4 baud)            | *    | baud rate 限制最大值为3M |

**示例**


   ```
   发-> 24 24 11 00 FF FF 25 01 00 00 00 00 00 00 00 00 00
   收-> 40 40 11 00 B3 97 A5 D9 05 04 0A 0B 0D 01 14 18 01
   ```

### 4.28 设置串口图传功能 (BINCMD_PIC_CFG 0x26)

**说明：**

1. 设置串口图传功能

> 配置图传指令之后，需重启设备才能生效

2. arg=get_cfg(1B),tx(1B),baud(4B)

   | arg | 取值 | 说明 |
   | --------------- | ---- | ------------------------------- |
   | get_cfg(1 byte) | 0x00, 0x01 | 当 get_cfg=0x01 时表示读取当前配置,模块回复的顺序与设置的参数一致,get_cfg为0xD9<br />当 get_cfg!=0x01 时表示进行设置,模块回复设置结果,0x00表示成功,其他值为失败 |
   | tx(1 byte)  | *    | 配置图传串口 TX IO , tx 为`255`禁用图传功能  |
   | baud(4 baud)    | *    | baud rate 限制最大值为3M |

**示例**


   ```
   发-> 24 24 0D 00 FF FF 26 01 00 00 00 00 00 //读取配置
   收-> 40 40 0D 00 AA B7 A6 00 1E 00 0E 10 00

   发-> 24 24 0D 00 FF FF 26 00 1E 00 0E 10 00 //设置IO30,Baud 921600
   收-> 24 24 0D 00 FF FF 26 00 1E 00 0E 10 00
   ```





## 附录

### CRC16代码参考

```
uint16_t crc16_xmodem(const uint8_t *buffer, uint32_t buffer_length)
{
    uint8_t c, treat, bcrc;
    uint16_t wcrc = 0;

    for(uint32_t i = 0; i < buffer_length; i++)
    {
        c = buffer[i];
        for(uint8_t j = 0; j < 8; j++)
        {
            treat = c & 0x80;
            c <<= 1;
            bcrc = (wcrc >> 8) & 0x80;
            wcrc <<= 1;
            if(treat != bcrc)
                wcrc ^= 0x1021;
        }
    }
    return wcrc;
}
```

### MF模块 内置默认图片资源地址

```
#define PIC_ICON_WIFI_ADDR	(0xc00000)
#define PIC_ICON_WIFI_SIZE	(16 * 16 * 2)

#define PIC_ICON_ETH_ADDR	(0xc00200)
#define PIC_ICON_ETH_SIZE	(16 * 16 * 2)

#define PIC_LOGO_RECORD_ADDR	(0xc00400)
#define PIC_LOGO_RECORD_SIZE	(240 * 240 * 2)

#define PIC_LOGO_CONNING_ADDR	(0xc1c600)
#define PIC_LOGO_CONNING_SIZE	(240 * 240 * 2)

#define PIC_LOGO_CONN_FAIL_ADDR	(0xc38800)
#define PIC_LOGO_CONN_FAIL_SIZE	(240 * 240 * 2)

#define PIC_LOGO_CONN_OK_ADDR	(0xc54a00)
#define PIC_LOGO_CONN_OK_SIZE	(240 * 240 * 2)

#define PIC_LOGO_QR_SHOW_ADDR	(0xc70c00)
#define PIC_LOGO_QR_SHOW_SIZE	(240 * 240 * 2)

#define PIC_LOGO_QR_ERR_ADDR	(0xc8ce00)
#define PIC_LOGO_QR_ERR_SIZE	(240 * 240 * 2)

#define PIC_LOGO_QR_TO_ADDR	(0xca9000)
#define PIC_LOGO_QR_TO_SIZE	(240 * 240 * 2)

#define PIC_LOGO_PASS_ADDR	(0xcc5200)
#define PIC_LOGO_PASS_SIZE	(240 * 286 * 2)

#define PIC_BAR_480214_ADDR	(0xce6a40)
#define PIC_BAR_480214_SIZE	(480 * 214 * 2)

#define PIC_BAR_24080_ADDR	(0xd18cc0)
#define PIC_BAR_24080_SIZE	(240 * 80 * 2)

#define PIC_BAR_360160_ADDR	(0xd222c0)
#define PIC_BAR_360160_SIZE	(360 * 160 * 2)

#define PIC_BAR_160480_ADDR	(0xd3e4c0)
#define PIC_BAR_160480_SIZE	(160 * 480 * 2)

#define PIC_BAR_480160_ADDR	(0xd63cc0)
#define PIC_BAR_480160_SIZE	(480 * 160 * 2)
```
